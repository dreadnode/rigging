---
name: Template Sync Dispatcher
on:
  workflow_run:
    workflows: ["Pre-Commit"]
    types:
      - completed
    branches:
      - main

  # checkov:skip=CKV_GHA_7: "Workflow dispatch inputs are required for manual debugging and configuration"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  check-changes:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      should_dispatch: ${{ steps.filter.outputs.templates }}
    steps:
      - name: Checkout triggering commit
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.ref }}

      - name: Check if template files changed
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: filter
        with:
          filters: |
            templates:
              - '.github/**'
              - '.hooks/**'
              - '.pre-commit-config.yaml'
              - '.mdlrc'
              - '.editorconfig'
              - 'Taskfile.yaml'
              - '.task/**'

  dispatch-to-targets:
    needs: check-changes
    runs-on: ubuntu-latest
    if: needs.check-changes.outputs.should_dispatch == 'true'
    strategy:
      matrix:
        repo:
          - ares
          - platform
          - sast-agent
          - dreadnode-server
          - dreadnode-sdk
          - rigging
    steps:
      - name: Generate Token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        id: app-token
        with:
          app-id: "${{ secrets.BOT_APP_ID }}"
          private-key: "${{ secrets.BOT_APP_PRIVATE_KEY }}"
          owner: "${{ github.repository_owner }}"

      - name: Dispatch to ${{ matrix.repo }}
        run: |
          gh api repos/dreadnode/${{ matrix.repo }}/dispatches \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -f event_type="template-sync" \
            -f client_payload[ref]="${{ github.event.workflow_run.head_sha }}"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
